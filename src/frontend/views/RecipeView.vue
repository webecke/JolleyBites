<script setup lang="ts">
import { useRoute } from 'vue-router'
import { computed, onMounted, ref } from 'vue'
import type { Recipe, IngredientRecipe } from '../../shared/types'
import { convertNewlinesToBr, formatDate, roundToTwoDecimals, trimObjectStrings } from '@/utils/formatUtils'
import { useDataStore } from '@/stores/dataStore'
import router from '@/router'
import { deleteRecipe, updateRecipe } from '@/services/RecipeService'
import { snackbarStore } from '@/stores/snackbarStore'
import { doErrorHandling } from '@/utils/generalUtils'
import { ServerCommunicator } from '@/services/ServerCommunicator'

const route = useRoute()

const data = useDataStore()
const id = ref(route.params.id as string)
const recipe = ref<Recipe>({} as Recipe)
const ingredientList = ref<IngredientRecipe[]>([])
const preEditedRecipe = ref<Recipe>({} as Recipe)
const showEditMode = ref<boolean>(false)
const showDeleteConfirmation = ref<boolean>(false)
const initialEdit = computed(() => recipe.value.created_at == recipe.value.updated_at)

onMounted(async () => {
  await loadRecipe()
})

const loadRecipe = async () => {
  const foundRecipe = useDataStore().getRecipe(Number(id.value))

  if (foundRecipe == null) {
    await router.push("/recipes");
    snackbarStore.showWarningMessage("Not Found: That recipe either doesn't belong to you, or no longer exists")
    return
  }
  recipe.value = foundRecipe

  await data.loadIngredientRecipes(recipe.value.id)
  const recipeIngredients = data.ingredientRecipes.get(recipe.value.id) || []
  ingredientList.value = [...recipeIngredients]

  if (initialEdit.value) {
    showEditMode.value = true
  }
}

const saveRecipe = async () => {
  recipe.value = trimObjectStrings<Recipe>(recipe.value)
  if (recipe.value.servings_per_recipe <= 0) {
    snackbarStore.showWarningMessage("Please enter a value greater than 0 for 'servings per recipe'")
    return
  } else if (recipe.value.name == "") {
    snackbarStore.showWarningMessage("Please enter a recipe name")
    return
  }

  await doErrorHandling(async () => {
    await updateRecipe(recipe.value)
    const updatedRecipe = useDataStore().getRecipe(recipe.value.id)
    if (updatedRecipe == null) {
      snackbarStore.showCriticalErrorMessage("Something went wrong saving the recipe, please reload the page")
      return
    }
    recipe.value = updatedRecipe
    showEditMode.value = false
  }, "saving changes to recipe")
}

const startEdit = () => {
  preEditedRecipe.value = { ...recipe.value }
  showEditMode.value = true
}

const cancelEdit = () => {
  if (initialEdit.value) {
    showDeleteConfirmation.value = true
    return
  }

  recipe.value = { ...preEditedRecipe.value }
  showEditMode.value = false
}

const doDeleteRecipe = async () => {
  await doErrorHandling(async () => {
    await deleteRecipe(recipe.value.id)
    snackbarStore.showSuccessMessage("Recipe deleted")
    await router.push("/recipes")
  }, "deleting recipe")
}
</script>

<template>
  <div id="recipeTopArea">
    <div style="width: 100%;">
      <h1 style="display: flex">
        <v-text-field v-if="showEditMode" v-model="recipe.name" label="Name"/>
        <span v-else>{{recipe.name}}</span>
      </h1>

      <v-text-field v-if="showEditMode" v-model="recipe.description" label="Description"/>
      <p v-else-if="recipe.description == ''"><em>No description</em></p>
      <p v-else>{{recipe.description}}</p>

      <p v-if="showEditMode">
        Servings per recipe:
        <v-text-field style="width: 100px" type="number" :error-messages="recipe.servings_per_recipe <= 0 ? 'Must be over zero' : ''" v-model="recipe.servings_per_recipe"/>
      </p>
      <p v-else><em>This recipe makes {{recipe.servings_per_recipe}} servings</em></p>
    </div>
    <v-btn v-if="showEditMode" @click="cancelEdit">
      Cancel
    </v-btn>
    <v-btn v-if="showEditMode" color="green" @click="saveRecipe">
      Save <font-awesome-icon :icon="['fas', 'file-arrow-up']" />
    </v-btn>
    <v-btn v-else @click="startEdit">
      Edit<font-awesome-icon :icon="['fas', 'pen-to-square']" />
    </v-btn>
  </div>

  <hr style="width: 100%;"/>

  <div>
    <h3>Recipe Cost: <b>${{roundToTwoDecimals(recipe.calculated_cost)}}</b></h3>
    <h3>Cost Per Serving: <b>${{roundToTwoDecimals(recipe.calculated_cost / recipe.servings_per_recipe)}}</b></h3>
  </div>

  <div class="flexableColumnContainer">
    <div class="flexableColumns" style="width: 60%">
      <p v-for="ingredient in ingredientList">You need {{ingredient.quantity_in_recipe}} units of ingredient #{{ingredient.ingredient_id}}</p>
    </div>
    <div class="flexableColumns" style="width: 40%">
      <v-textarea
        v-if="showEditMode"
        v-model="recipe.instructions"
        label="Instructions"
        placeholder="How to actually make this"
        :rows="3"
        auto-grow
        outlined
      />
      <div v-else>
        <h3>Instructions:</h3>
        <p v-if="recipe.instructions == ''"><em>No instructions</em></p>
        <p v-else v-html="convertNewlinesToBr(recipe.instructions)"/>
      </div>

      <v-textarea
        v-if="showEditMode"
        v-model="recipe.notes"
        label="Notes"
        placeholder="Things to remember about this recipe"
        :rows="2"
        auto-grow
        outlined
      />
      <div v-else>
        <hr style="width: 100%;"/>
        <h3>Notes:</h3>
        <p v-if="recipe.notes == ''"><em>No notes</em></p>
        <p v-else v-html="convertNewlinesToBr(recipe.notes)"/>
      </div>

      <hr style="width: 100%;"/>

      <p>Created {{formatDate(recipe.created_at)}}</p>
      <p>Last edited {{formatDate(recipe.updated_at)}}</p>
      <v-btn v-if="showEditMode" color="red" @click="showDeleteConfirmation = true">Delete Recipe</v-btn>
    </div>
  </div>


  <v-dialog
    v-model="showDeleteConfirmation"
    width="auto"
    min-width="300px">
    <v-card v-if="initialEdit" title="Are you sure?">
      <template v-slot:text>
        <p>Do you want to cancel creating this recipe?</p>
        <p><em>You can not undo this</em></p>
      </template>
      <template v-slot:actions>
        <v-btn @click="doDeleteRecipe" color="red">Cancel creating recipe</v-btn>
        <v-btn @click="showDeleteConfirmation = false">Continue making recipe</v-btn>
      </template>
    </v-card>
    <v-card v-else title="Are you sure?">
      <template v-slot:text>
        <p>Do you want to delete your {{recipe.name}} recipe?</p>
        <p><em>You can not undo this</em></p>
      </template>
      <template v-slot:actions>
        <v-btn @click="doDeleteRecipe" color="red">Delete</v-btn>
        <v-btn @click="showDeleteConfirmation = false">Cancel</v-btn>
      </template>
    </v-card>
  </v-dialog>
</template>

<style scoped>
#recipeTopArea {
  display: flex;
  justify-content: space-between;
}

.flexableColumnContainer {
  display: flex;
  flex-wrap: wrap;
  margin-top: 20px;
}

@media screen and (max-width: 600px) {
  .flexableColumns {
    flex: 100%;
  }
}
</style>
